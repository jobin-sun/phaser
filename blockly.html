<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>test</title>
  <style type="text/css" media="screen">
  	.optBtn{
  		width: 5em;
  		display: block;
  		margin: 5px 0;
  	}
  </style>
</head>
<body>

<div id="blocklyDiv" style="height: 480px; width: 500px; float: left"></div>
<div style='float: left'>
	<div style="float: left; padding-left: 1em; padding-right: 1em;">
		<button class="optBtn" type="button" onclick="runCode()">运行</button>
		<button class="optBtn" type="button" onclick="runCode()">保存</button>
		<button class="optBtn" type="button" onclick="runCode()">分享</button>
	</div>
	<div id='gameContainer' style="width: 375px; height: 667px; float: left"></div>

	<div style="clear: both">
		
	</div>
</div>
<!--iframe src="game.html" id='game' style="width: 375px; height: 667px; clear: both"></iframe-->

<xml id="toolbox" style="display: none">
  <category name="语法">
  	<category name="逻辑" colour="210">
      <block id='aaa' type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_null"></block>
      <block type="logic_ternary"></block>
    </category>
    <category name="循环" colour="120">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
        <value name="BY">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>
    <category name="数学" colour="230">
      <block type="math_number"></block>
      <block type="math_arithmetic">
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_single">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">9</field>
          </shadow>
        </value>
      </block>
      <block type="math_trig">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">45</field>
          </shadow>
        </value>
      </block>
      <block type="math_constant"></block>
      <block type="math_number_property">
        <value name="NUMBER_TO_CHECK">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="math_round">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">3.1</field>
          </shadow>
        </value>
      </block>
      <block type="math_on_list"></block>
      <block type="math_modulo">
        <value name="DIVIDEND">
          <shadow type="math_number">
            <field name="NUM">64</field>
          </shadow>
        </value>
        <value name="DIVISOR">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="math_constrain">
        <value name="VALUE">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="LOW">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="HIGH">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_float"></block>
    </category>
    <category name="文本" colour="160">
      <block type="text"></block>
      <block type="text_join"></block>
      <block type="text_append">
        <value name="TEXT">
          <shadow type="text"></shadow>
        </value>
      </block>
      <block type="text_length">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_isEmpty">
        <value name="VALUE">
          <shadow type="text">
            <field name="TEXT"></field>
          </shadow>
        </value>
      </block>
      <block type="text_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
        <value name="FIND">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_charAt">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_getSubstring">
        <value name="STRING">
          <block type="variables_get">
            <field name="VAR">{textVariable}</field>
          </block>
        </value>
      </block>
      <block type="text_changeCase">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_trim">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_print">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
      <block type="text_prompt_ext">
        <value name="TEXT">
          <shadow type="text">
            <field name="TEXT">abc</field>
          </shadow>
        </value>
      </block>
    </category>
    <category name="列表" colour="260">
      <block type="lists_create_with">
        <mutation items="0"></mutation>
      </block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">5</field>
          </shadow>
        </value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getIndex">
        <value name="VALUE">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_setIndex">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_getSublist">
        <value name="LIST">
          <block type="variables_get">
            <field name="VAR">{listVariable}</field>
          </block>
        </value>
      </block>
      <block type="lists_split">
        <value name="DELIM">
          <shadow type="text">
            <field name="TEXT">,</field>
          </shadow>
        </value>
      </block>
      <block type="lists_sort"></block>
    </category>
    <category name="颜色" colour="20">
      <block type="colour_picker"></block>
      <block type="colour_random"></block>
      <block type="colour_rgb">
        <value name="RED">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
        <value name="GREEN">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="BLUE">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="colour_blend">
        <value name="COLOUR1">
          <shadow type="colour_picker">
            <field name="COLOUR">#ff0000</field>
          </shadow>
        </value>
        <value name="COLOUR2">
          <shadow type="colour_picker">
            <field name="COLOUR">#3333ff</field>
          </shadow>
        </value>
        <value name="RATIO">
          <shadow type="math_number">
            <field name="NUM">0.5</field>
          </shadow>
        </value>
      </block>
    </category>
    <sep></sep>
    <category name="变量" colour="330" custom="VARIABLE"></category>
    <category name="自定义函数" colour="290" custom="PROCEDURE"></category>
  </category>
</xml>

<script src="src/blockly_compressed.js"></script>
<script src="src/javascript_compressed.js"></script>
<script src="src/blocks_compressed.js"></script>
<script src="src/msg/js/zh-hans.js"></script>
<script src="src/blocks/object.js"></script>
<script src="node_modules/phaser/build/phaser.min.js"></script>


<script>
  var workspace = Blockly.inject('blocklyDiv',
  {
      	toolbox: document.getElementById('toolbox'),
      	zoom:
         {controls: true,
          wheel: true,
          startScale: 1.0,
          maxScale: 3,
          minScale: 0.3,
          scaleSpeed: 1.2},
     	trashcan: true
  });
  function runCode(){
  	var code = Blockly.JavaScript.workspaceToCode(workspace);
  	console.log(code);
  	(function(){
  		"use strict";
  		eval(document.querySelector("#gameTpl").innerHTML)
  	})()
  	//document.getElementById("game").contentWindow.reset(code)
  }
  
</script>

<script id="gameTpl" type = "text/template">
	if(window.game){
		window.game.destroy()
	}
	var config = {
        width: 375,
        height: 667
    }
    var game = new Phaser.Game(config.width, config.height, Phaser.AUTO, 'gameContainer');
    window.game = game
    var progressText
    var state = {
	    	boot:{
		    	preload: function(){
		    		game.load.image('loading', 'static/loading.gif')
		    	},
		    	create: function(){
		    		game.state.start('loader')
		    	}
		    },
		    loader: {
		    	init: function(){
		    		var sprite = game.add.image(game.world.centerX, game.world.centerY - 20, 'loading')
		    		sprite.anchor = {x: 0.5, y: 0.5}
		    		sprite.width /= 2
		    		sprite.height /= 2
		    		progressText = game.add.text(game.world.centerX, game.world.centerY + 30, '0%', { fill: '#fff', fontSize: '16px'})
		    		progressText.anchor = { x: 0.5, y: 0.5}
		    	},
		    	preload: function(){
				    game.load.image('plane', 'static/plane.png')
				    game.load.image('bg', 'static/gamebackdrop.gif')
				    game.load.onFileComplete.add(function(progress){
				    	progressText.text = progress + '%'
				    })
		    	},
		    	create: function(){
		    		game.state.start('game')
		    	}
		    },
		    game: {
		    	preload: function(){
				    console.log('game preload')
		    	},
		    	create: function(){
		            var bg = game.add.image(0, 0, 'bg')
		            bg.width = game.world.width
		            bg.height = game.world.height
		            var plane = game.add.image(game.world.centerX, game.world.height - 40, 'plane')
		    		plane.anchor = {x: 0.5, y: 0.5}
		    		plane.update = function(){
		    			if(game.input.mousePointer.isDown || game.input.pointer1.isDown){
		    				console.log(game.input.position)
		    				this.x = game.input.position.x
		    				//this.y = game.input.position.y
		    				//this.angle += 1
		    			}
		                
		            }
		    	},
		    	update: function(){
		    		//console.log('game update')
		    	}
		    }
	    }
    game.state.add('boot', state.boot)
    game.state.add('loader', state.loader)
    game.state.add('game', state.game)
    game.state.start('boot')
    

    function preload () {
        for(var i = 0; i < spriteList.length; i++){
            game.load.image(spriteList[i].name, spriteList[i].url);
        }

    }

    function create () {
        game.load.onLoadStart.add(loadStart, this);
        game.load.onFileComplete.add(fileComplete, this);
        game.load.onLoadComplete.add(loadComplete, this);
        for(var i = 0; i < spriteList.length; i++){
            var ob = spriteList[i]
            ob.sprite = game.add.sprite(ob.position.x, ob.position.y, ob.name);
            ob.sprite.anchor.setTo(ob.anchor.x, ob.anchor.y)
        }
	    game.load.image('picture1', 'static/sprites.png');
	    game.load.image('picture2', 'static/sprites.png');
	    game.load.image('picture3', 'static/sprites.png');
	    game.load.image('picture4', 'static/sprites.png');
	    game.load.image('picture5', 'static/sprites.png');
	    game.load.image('picture6', 'static/sprites.png');
	    game.load.image('picture7', 'static/sprites.png');
        game.load.start();
    }
    function loadStart() {
        console.log("loadStart")
    }

    //  This callback is sent the following parameters:
    function fileComplete(progress, cacheKey, success, totalLoaded, totalFiles) {
        console.log(progress, cacheKey, success, totalLoaded, totalFiles)
    }

    function loadComplete() {
        console.log('loadComplete')
    }
    function update(){
    	console.log(3333)
        for(var i = 0; i < spriteList.length; i++){
            if(typeof spriteList[i].update === 'function'){

                spriteList[i].update()
            }
        }
        //console.log("update")
        //logo.angle += 1
        //console.log(logo.angle)
    }
    function reset(code){
        game.destroy()
        spriteList = []
        spriteList.push({
            name: 'logo',
            url: 'static/sprites.png',
            position: {
                x: config.width/2,
                y: config.height/2
            },
            anchor: {
                x: 0.5,
                y: 0.5
            },
            update: function(){
                this.sprite.angle += 1
            }
        })
        initGame()
    }
</script>


</body>
</html>

